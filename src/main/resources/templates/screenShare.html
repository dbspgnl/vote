<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
    <div class="card p-3">
        <div>
            <p><h1>화면 공유 테스트</h1></p>
        </div>
        <!-- <div>
            <button class="btn btn-warning" onclick="connectWs()" id="startBtn"> 시작하기</button>
        </div> -->
        <br/>
        <div>메시지: </div><input id="chatting"></input>&nbsp;&nbsp;<button class="btn btn-success" onclick="send()">보내기 </button>
        <hr/>

        <video controls width="400">
            <source src="/video/Seoul.mp4" type="video/mp4">
        </video>

        <div>
            <p id="chat"></p>
        </div>
        
    </div>

    <script type="text/javascript">
        // Client's local state
        let raw_url = null
        let streamable_url = null
        let video_playing = null
        let last_updated = 0
        let client_uid = null

        //Clock synchronisation related variables
        const num_time_sync_cycles = 10
        let over_estimates = new Array()
        let under_estimates = new Array()
        let over_estimate = 0
        let under_estimate = 0
        let correction = 0

        var ws;
        var beforeTime;
        function connectWs() {
            console.log("커넥트");
            ws = new WebSocket('ws://' + location.host + '/screenShare/message');
            ws.onmessage = function(data) { // 서버에서의 리턴 값 처리
                $("<p>시간체크: "+data.data+"</p>").prependTo('#chat');

                // 시간을 Json으로 처리해야할듯
                var state = JSON.parse(data.data); // 시간
                console.log(JSON.parse(data.data)); // {data: '1'}
                console.log(state.data); // 1
                
                // 만약 실행중이라면 중지해서 처리해야함

                // 만약 중지중이면 실행 시켜야함
                
                if(Math.floor(vid.currentTime) != Math.floor(state)){
                    console.log(data);
                    console.log("state: "+state);
                    console.log("beforeTime: "+beforeTime);
                    if(state - beforeTime > 1){
                        vid.currentTime = state
                        vid.play()
                    }
                    
                }

                
                // if (client_uid == null){
                //     client_uid = state.client_uid;
                // }

                // // someone changed the video
                // if (vid_src.src !== state.streamable_url){
                //     vid.pause()
                //     // raw_url = state.raw_url
                //     // streamable_url = state.streamable_url
                //     // vid_src.src = streamable_url 
                //     vid.load()
                // } 

                // // let proposed_time = (state.playing) ? ((state.video_timestamp - state.global_timestamp) + get_global_time(correction) ) : (state.video_timestamp)
                // // let gap = Math.abs(proposed_time - vid.currentTime)
                // // console.log(`%cGap was ${proposed_time - vid.currentTime}`, 'font-size:12px; color:purple')

                // if (state.playing){
                //     if(gap > PLAYING_THRESH){
                //         // tolerance while the video is playing
                //         vid.currentTime = state
                //     }
                //     vid.play()
                // }
                // else{
                //     vid.pause()
                //     if (gap > PAUSED_THRESH){
                //         // condition to prevent an unnecessary seek
                //         vid.currentTime = state
                //     }
                // }


            }
            
            // // Whenever the client connects or reconnects
            // if (client_uid == null){
            //     client_uid = state.client_uid;
            // }

            // // someone changed the video
            // if (vid_src.src !== state.streamable_url){
            //     vid.pause()
            //     raw_url = state.raw_url
            //     streamable_url = state.streamable_url
            //     vid_src.src = streamable_url 
            //     vid.load()
            // } 

            // // calculating the new timestamp for both cases - when the video is playing and when it is paused
            // let proposed_time = (state.playing) ? ((state.video_timestamp - state.global_timestamp) + get_global_time(correction) ) : (state.video_timestamp)
            // let gap = Math.abs(proposed_time - vid.currentTime)

            // console.log(`%cGap was ${proposed_time - vid.currentTime}`, 'font-size:12px; color:purple')

            // if (state.playing){
            //     if(gap > PLAYING_THRESH){
            //         // tolerance while the video is playing
            //         vid.currentTime = proposed_time
            //     }
            //     vid.play()
            // }
            // else{
            //     vid.pause()
            //     if (gap > PAUSED_THRESH){
            //         // condition to prevent an unnecessary seek
            //         vid.currentTime = proposed_time
            //     }
            // }

        }

        function send() {
            ws.send($("#chatting").val());
            $('#chatting').val("");
        }

        const vid = document.querySelector('video');
        vid.currentTime = 1;
        connectWs(); // 소켓 시작
        beforeTime = 1;

        vid.onended = () => {
            console.log("영상 종료");
            // video_playing = false
            // last_updated = get_global_time(correction)
            // vid.load()
            // state_change_handler()
        }
        vid.oncanplay = () => {
            console.log("oncanplay: "+vid.currentTime);
            beforeTime = vid.currentTime;
            ws.send(vid.currentTime);
        }

        let state_change_handler = (event) => {
            if (event !== null && event !== undefined){
                if (event.type === 'pause'){
                    video_playing = false
                }
                else if (event.type === 'play'){
                    video_playing = true
                }
            }
            last_updated = get_global_time(correction)
            state_image = {
                video_timestamp: vid.currentTime,
                last_updated: last_updated,
                playing: video_playing,
                global_timestamp: get_global_time(correction),
                raw_url : raw_url,
                streamable_url: streamable_url,
                client_uid: client_uid
            }
            // socket.emit("state_update_from_client", state_image)
           
        }

        // assigning event handlers
        vid.onseeking = state_change_handler
        vid.onplay = state_change_handler
        vid.onpause = state_change_handler

        function get_global_time(delta = 0){
            let d = new Date()
            let t = d.getTime()/1000
            // delta is the correction parameter
            return t + delta
        }

    </script>
    
</body>
</html>